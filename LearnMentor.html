<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üìö Learn Mentor</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ... (Estilos CSS anteriores sin cambios significativos, excepto los nuevos para notificaciones y test) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.97); /* Slightly more opaque */
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15); /* Softer shadow */
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }
        
        .config-details {
            background: #f0f3ff;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #d1d9ff;
        }

        .config-details summary {
            padding: 20px 25px;
            font-weight: 600;
            font-size: 1.4rem;
            color: #4a5568; 
            cursor: pointer;
            outline: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .config-details summary::after {
            content: '‚ñº'; 
            font-size: 1rem;
            transition: transform 0.2s ease-in-out;
        }

        .config-details[open] summary::after {
            transform: rotate(180deg);
        }

        .config-content {
            padding: 0 25px 25px 25px;
        }
        
        .config-section { 
            background: #f8f9ff;
            border-radius: 10px; 
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ff;
        }


        .config-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem; 
            border-bottom: 1px solid #e1e8ff;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"], /* Added for number input */
        .form-group select,
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group input[type="number"]:focus,
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .model-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .file-upload-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid #e1e8ff;
        }
        .file-upload-section h3 {
             color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }


        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .files-list {
            background: white;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .file-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .file-item:hover {
            background: #f8f9ff;
        }

        .file-item.selected {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-flex; /* For icon alignment */
            align-items: center; /* For icon alignment */
            justify-content: center; /* For icon alignment */
            gap: 8px; /* Space between icon and text */
        }
        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #ddd;
        }
        .btn-secondary:hover { background: #e9ecef; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        .btn-success { background-color: #28a745; color: white; } 
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; color: white; } /* New button color */
        .btn-danger:hover { background-color: #c82333; }
        .btn-exam { background: linear-gradient(135deg, #fd7e14, #ffc107); color: white; }
        .btn-exam:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(253, 126, 20, 0.3); }


        .questions-container {
            background: white;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
            margin-top: 30px;
            padding: 25px;
        }

        .question-item {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e1e8ff;
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .answer-input, .fill-blank-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 15px;
        }
        .answer-input:focus, .fill-blank-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .fill-blank-input { 
            min-height: auto; 
            display: inline-block;
            width: auto;
            margin: 0 5px;
            padding: 5px 8px;
            min-width: 100px; 
        }
        .text-part-fill { margin-bottom: 10px; }


        .test-options { margin-bottom: 15px; }
        .test-option {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .test-option:hover { background-color: #e9ecef; }
        .test-option input[type="radio"], .test-option input[type="checkbox"] { margin-right: 10px; }
        .test-option.selected-option { background-color: #d1e7fd; border-color: #0d6efd; }
        .test-option.correct-option { background-color: #d1e7dd; border-color: #198754; }
        .test-option.incorrect-option { background-color: #f8d7da; border-color: #dc3545; }


        .result-container {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none; 
            transition: background-color 0.5s ease;
        }
        .result-container .markdown-content h1,
        .result-container .markdown-content h2,
        .result-container .markdown-content h3 { margin-top: 0.5em; margin-bottom: 0.3em; line-height: 1.2;}
        .result-container .markdown-content p { margin-bottom: 0.5em; }
        .result-container .markdown-content ul,
        .result-container .markdown-content ol { margin-left: 20px; margin-bottom: 0.5em; }
        .result-container .markdown-content code { background-color: #eee; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
        .result-container .markdown-content pre code { display: block; padding: 10px; }

        .result-correct { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .result-incorrect { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        .result-warning { background: #fff3cd; border: 2px solid #ffeeba; color: #664d03; } 


        .explanation-section { margin-top: 10px; }
        .rebuttal-section { margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 8px; }
        .rebuttal-section textarea { width: 100%; min-height: 60px; margin-bottom:10px; }


        .loading { display: none; text-align: center; padding: 20px; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050; 
            width: 300px;
        }
        .toast-notification {
            background-color: #333;
            color: #fff;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(100%); 
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-notification.error { background-color: #dc3545; }
        .toast-notification.success { background-color: #198754; }
        .toast-notification.info { background-color: #0dcaf0; color: #000;}


        .alert { 
            padding: 15px; border-radius: 10px; margin: 15px 0; font-weight: 600;
            transition: opacity 0.3s ease-out;
        }
        .alert-error { background: #f8d7da; border: 2px solid #f5c6cb; color: #721c24; }
        .alert-success { background: #d4edda; border: 2px solid #c3e6cb; color: #155724; }
        .hidden { display: none !important; }
        
        #examConfigSection {
            background: #e9f0ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            border: 1px solid #c8d7ff;
        }
        #examConfigSection h4 {
            margin-bottom: 15px;
            color: #333;
        }
        #examConfigSection .form-group {
            display: flex;
            align-items: center;
            gap: 10px; 
        }
        #examConfigSection .form-group label {
            flex-basis: 200px; 
            margin-bottom: 0; 
        }
        #examConfigSection .form-group input[type="number"] {
            flex-grow: 1; 
            max-width: 80px; 
        }
        .api-key-actions { margin-top: 10px; }


        @media (max-width: 768px) {
            body { padding: 10px; }
            .config-details summary { font-size: 1.2rem; padding: 15px 20px;}
            .header h1 { font-size: 2rem; }
            .main-content { padding: 20px; }
            .config-section, .file-upload-section { padding: 20px; }
            .btn { width: 100%; margin: 8px 0; } 
            .file-item { padding: 12px 15px; font-size: 14px; }
            #notification-container { width: calc(100% - 40px); top:10px; right:10px; }
            #examConfigSection .form-group { flex-direction: column; align-items: flex-start; }
            #examConfigSection .form-group label { flex-basis: auto; margin-bottom: 5px; }
            #examConfigSection .form-group input[type="number"] { width: 100%; max-width: none; }
        }
    </style>
</head>
<body>
    <div id="notification-container"></div>

    <div class="container">
        <div class="header">
            <h1>üìö Learn Mentor</h1>
            <p>Aprende gracias a tu profesor IA ü§ñ</p>
        </div>

        <div class="main-content">
            <details class="config-details" id="configDetails">
                <summary>‚öôÔ∏è Configuraci√≥n de API y Preferencias</summary>
                <div class="config-content">
                    <div class="config-section">
                        <h3>üîå Proveedor de API</h3>
                        <div class="form-group">
                            <label for="apiProvider">Selecciona el proveedor de API:</label>
                            <select id="apiProvider" class="form-control" onchange="handleApiProviderChange()">
                                <option value="openrouter">OpenRouter</option>
                                <option value="google">Google Gemini (REST API)</option>
                            </select>
                        </div>
                    </div>

                    <div class="config-section" id="openrouterConfigSection">
                        <h3>üîë Configuraci√≥n OpenRouter</h3>
                        <div class="form-group">
                            <label for="openrouterApiKey">API Key de OpenRouter:</label>
                            <input type="password" id="openrouterApiKey" class="form-control" placeholder="Introduce tu API Key de OpenRouter" />
                            <div class="api-key-actions">
                                <button class="btn btn-info btn-sm" onclick="testApiKey('openrouter')">üß™ Probar Key</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="config-section hidden" id="googleConfigSection">
                        <h3>üîë Configuraci√≥n Google Gemini</h3>
                        <div class="form-group">
                            <label for="googleApiKey">API Key de Google AI Studio:</label>
                            <input type="password" id="googleApiKey" class="form-control" placeholder="Introduce tu API Key de Google" />
                             <div class="api-key-actions">
                                <button class="btn btn-info btn-sm" onclick="testApiKey('google')">üß™ Probar Key</button>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                         <h3>ü§ñ Modelo de IA</h3>
                        <div class="form-group">
                            <label for="modelSelect">Selecciona el Modelo:</label>
                            <select id="modelSelect" class="form-control">
                                <option value="">Cargando modelos...</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadModels(true)" style="margin-top: 10px;">
                                üîÑ Recargar Modelos
                            </button>
                             <small class="model-info" id="modelProviderInfo">Los modelos se listar√°n seg√∫n el proveedor.</small>
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <h3>üéì Preferencias Adicionales</h3>
                        <div class="form-group">
                            <label for="educationLevel">Nivel de Educaci√≥n (para explicaciones):</label>
                            <select id="educationLevel" class="form-control">
                                <option value="Primaria">Primaria</option>
                                <option value="Secundaria">Secundaria</option>
                                <option value="Universitario">Universitario</option>
                            </select>
                            <small class="model-info">La explicaci√≥n se adaptar√° seg√∫n este nivel.</small>
                        </div>
                        <div class="form-group">
                            <label for="numQuestions">N√∫mero de Preguntas a Generar (1-10):</label>
                            <input type="number" id="numQuestions" class="form-control" value="5" min="1" max="10">
                            <small class="model-info">Se aplicar√° a la generaci√≥n individual y "Generar M√°s".</small>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                </div>
            </details>

            <div class="file-upload-section">
                <h3>üìÅ Cargar Archivos Markdown</h3>
                <div class="file-upload">
                    <input type="file" id="fileInput" multiple accept=".md" onchange="handleFileSelection()" />
                    <label for="fileInput" class="file-upload-btn">
                        üì§ Seleccionar archivos .md
                    </label>
                </div>
                <div id="filesList" class="files-list hidden"></div>
                <button id="clearFileBtn" class="btn btn-danger btn-sm hidden" onclick="clearSelectedFile()" style="margin-top: 10px;">
                    üßπ Limpiar Selecci√≥n
                </button>
                
                <div id="generationButtons" class="hidden" style="margin-top:15px; display:flex; flex-wrap:wrap; gap:10px;">
                    <button class="btn btn-primary" style="flex-grow:1;" onclick="generateItems('development')">
                        üß† P. Desarrollo
                    </button>
                    <button class="btn btn-info" style="flex-grow:1;" onclick="generateItems('test')">
                        üìù Test (Op. √önica)
                    </button>
                    <button class="btn btn-success" style="flex-grow:1;" onclick="generateItems('fill_in_the_blanks')">
                        üß© Completar Texto
                    </button>
                    <button class="btn btn-warning" style="flex-grow:1;" onclick="generateItems('multi_choice_test')">
                        ‚òëÔ∏è Test (Op. M√∫ltiple)
                    </button>
                    <button class="btn btn-exam" style="flex-grow:1; width:100%; margin-top:10px;" onclick="toggleExamConfig()">
                        üéì Generar Examen Mixto
                    </button>
                </div>
                <div id="examConfigSection" class="hidden">
                    <h4>üìù Configurar Examen (N√∫mero de preguntas por tipo)</h4>
                    <div class="form-group">
                        <label for="examNumDevelopment">Preguntas de Desarrollo:</label>
                        <input type="number" id="examNumDevelopment" class="form-control" value="2" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="examNumTest">Test (Opci√≥n √önica):</label>
                        <input type="number" id="examNumTest" class="form-control" value="2" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="examNumFill">Completar Texto:</label>
                        <input type="number" id="examNumFill" class="form-control" value="1" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label for="examNumMultiTest">Test (Opci√≥n M√∫ltiple):</label>
                        <input type="number" id="examNumMultiTest" class="form-control" value="1" min="0" max="10">
                    </div>
                    <button class="btn btn-primary" style="width:auto; margin-top:10px;" onclick="generateExam()">
                        üöÄ Iniciar Generaci√≥n de Examen
                    </button>
                </div>

            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p id="loadingMessage">Procesando...</p>
            </div>

            <div id="questionsContainer" class="questions-container hidden">
                <h3 id="questionsTitle">ü§î Preguntas Generadas</h3>
                <div id="questionsList"></div>
                <button id="generateMoreBtn" class="btn btn-secondary hidden" onclick="generateMoreItems()">
                    üîÑ Generar M√°s del Mismo Tipo
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Constants ---
        const LS_PREFIX = 'learnMentor_';
        const LS_KEYS = {
            API_PROVIDER: `${LS_PREFIX}api_provider`,
            OPENROUTER_API_KEY: `${LS_PREFIX}openrouter_api_key`,
            GOOGLE_API_KEY: `${LS_PREFIX}google_api_key`,
            SELECTED_MODEL: `${LS_PREFIX}selected_model`,
            EDUCATION_LEVEL: `${LS_PREFIX}education_level`,
            NUM_QUESTIONS: `${LS_PREFIX}num_questions`,
            LAST_SELECTED_OR_MODEL: `${LS_PREFIX}last_selected_or_model`,
            LAST_SELECTED_GOOGLE_MODEL: `${LS_PREFIX}last_selected_google_model`,
            EXAM_NUM_DEV: `${LS_PREFIX}exam_num_dev`,
            EXAM_NUM_TEST: `${LS_PREFIX}exam_num_test`,
            EXAM_NUM_FILL: `${LS_PREFIX}exam_num_fill`,
            EXAM_NUM_MULTI: `${LS_PREFIX}exam_num_multi`,
        };

        const DEFAULT_NUM_QUESTIONS = 5;
        const DEFAULT_EDUCATION_LEVEL = 'Primaria';
        const DEFAULT_API_PROVIDER = 'openrouter';

        // --- Global State ---
        let selectedFiles = [];
        let selectedFileIndex = -1;
        let currentContent = '';
        let existingQuestions = []; 
        let currentQuestionType = 'development'; 
        
        let availableModelsOpenRouter = [];
        let availableGoogleModels = []; 
        
        let config = {
            apiProvider: localStorage.getItem(LS_KEYS.API_PROVIDER) || DEFAULT_API_PROVIDER,
            openrouterApiKey: localStorage.getItem(LS_KEYS.OPENROUTER_API_KEY) || '',
            googleApiKey: localStorage.getItem(LS_KEYS.GOOGLE_API_KEY) || '',
            selectedModel: localStorage.getItem(LS_KEYS.SELECTED_MODEL) || '',
            educationLevel: localStorage.getItem(LS_KEYS.EDUCATION_LEVEL) || DEFAULT_EDUCATION_LEVEL,
            numQuestions: parseInt(localStorage.getItem(LS_KEYS.NUM_QUESTIONS)) || DEFAULT_NUM_QUESTIONS,
            lastSelectedOpenRouterModel: localStorage.getItem(LS_KEYS.LAST_SELECTED_OR_MODEL) || '',
            lastSelectedGoogleModel: localStorage.getItem(LS_KEYS.LAST_SELECTED_GOOGLE_MODEL) || '',
            examNumDevelopment: parseInt(localStorage.getItem(LS_KEYS.EXAM_NUM_DEV)) || 2,
            examNumTest: parseInt(localStorage.getItem(LS_KEYS.EXAM_NUM_TEST)) || 2,
            examNumFill: parseInt(localStorage.getItem(LS_KEYS.EXAM_NUM_FILL)) || 1,
            examNumMultiTest: parseInt(localStorage.getItem(LS_KEYS.EXAM_NUM_MULTI)) || 1,
        };

        const modelIntelligenceOrderOpenRouter = [ 
            'anthropic/claude-3.5-sonnet', 'openai/gpt-4o', 'openai/gpt-4-turbo', 'google/gemini-pro-2.5',
            'meta-llama/llama-3.1-405b', 'meta-llama/llama-3.1-70b', 'deepseek/deepseek-r1', 'qwen/qwen-2.5-72b',
            'microsoft/wizardlm-2-8x22b', 'meta-llama/llama-3.1-8b', 'google/gemma-2-27b', 'mistralai/mixtral-8x7b',
            'microsoft/phi-3', 'google/gemma-2-9b'
        ];
        
        // --- Initialization ---
        async function init() {
            document.getElementById('apiProvider').value = config.apiProvider;
            document.getElementById('openrouterApiKey').value = config.openrouterApiKey;
            document.getElementById('googleApiKey').value = config.googleApiKey;
            document.getElementById('educationLevel').value = config.educationLevel;
            document.getElementById('numQuestions').value = config.numQuestions;
            
            document.getElementById('examNumDevelopment').value = config.examNumDevelopment;
            document.getElementById('examNumTest').value = config.examNumTest;
            document.getElementById('examNumFill').value = config.examNumFill;
            document.getElementById('examNumMultiTest').value = config.examNumMultiTest;

            handleApiProviderChange(false); // Load models based on provider without initial alerts

            const configDetails = document.getElementById('configDetails');
            if ( (config.apiProvider === 'openrouter' && !config.openrouterApiKey) ||
                 (config.apiProvider === 'google' && !config.googleApiKey) ) {
                configDetails.open = true;
            }
        }
        
        // --- Configuration Management ---
        function handleApiProviderChange(showAlerts = true) {
            config.apiProvider = document.getElementById('apiProvider').value;
            const openrouterSection = document.getElementById('openrouterConfigSection');
            const googleSection = document.getElementById('googleConfigSection');
            const modelProviderInfo = document.getElementById('modelProviderInfo');

            if (config.apiProvider === 'openrouter') {
                openrouterSection.classList.remove('hidden');
                googleSection.classList.add('hidden');
                modelProviderInfo.textContent = "Modelos de OpenRouter. Introduce tu API Key de OpenRouter.";
                // If current selectedModel is a Google model, clear it or pick last OR model
                if (config.selectedModel && config.selectedModel.startsWith('models/')) {
                    config.selectedModel = config.lastSelectedOpenRouterModel || '';
                } else {
                     config.selectedModel = config.lastSelectedOpenRouterModel || config.selectedModel;
                }
            } else { // Google
                openrouterSection.classList.add('hidden');
                googleSection.classList.remove('hidden');
                modelProviderInfo.textContent = "Modelos de Google Gemini (v√≠a REST API). Introduce tu API Key de Google.";
                // If current selectedModel is an OpenRouter model, clear it or pick last Google model
                if (config.selectedModel && !config.selectedModel.startsWith('models/')) {
                    config.selectedModel = config.lastSelectedGoogleModel || '';
                } else {
                    config.selectedModel = config.lastSelectedGoogleModel || config.selectedModel;
                }
            }
            loadModels(showAlerts); 
        }

        function saveConfig() {
            config.apiProvider = document.getElementById('apiProvider').value;
            config.openrouterApiKey = document.getElementById('openrouterApiKey').value.trim();
            config.googleApiKey = document.getElementById('googleApiKey').value.trim();
            config.selectedModel = document.getElementById('modelSelect').value;
            config.educationLevel = document.getElementById('educationLevel').value;
            config.numQuestions = parseInt(document.getElementById('numQuestions').value) || DEFAULT_NUM_QUESTIONS;
            
            config.examNumDevelopment = parseInt(document.getElementById('examNumDevelopment').value) || 0;
            config.examNumTest = parseInt(document.getElementById('examNumTest').value) || 0;
            config.examNumFill = parseInt(document.getElementById('examNumFill').value) || 0;
            config.examNumMultiTest = parseInt(document.getElementById('examNumMultiTest').value) || 0;


            if (config.numQuestions < 1 || config.numQuestions > 10) {
                showToast('El n√∫mero de preguntas debe estar entre 1 y 10.', 'error');
                config.numQuestions = Math.max(1, Math.min(10, config.numQuestions)); 
                document.getElementById('numQuestions').value = config.numQuestions;
                // Do not return here, save other valid settings
            }

            if (config.apiProvider === 'openrouter') {
                if (!config.openrouterApiKey) { showToast('Por favor, introduce una API Key de OpenRouter.', 'error'); /* return; */ }
                config.lastSelectedOpenRouterModel = config.selectedModel;
            } else { 
                if (!config.googleApiKey) { showToast('Por favor, introduce una API Key de Google.', 'error'); /* return; */ }
                config.lastSelectedGoogleModel = config.selectedModel;
            }
            
            const isApiReady = (config.apiProvider === 'openrouter' && config.openrouterApiKey) ||
                               (config.apiProvider === 'google' && config.googleApiKey);
            
            if (isApiReady && !config.selectedModel) {
                 showToast('Por favor, selecciona un modelo de IA.', 'warning'); // Warning, not error
            }

            localStorage.setItem(LS_KEYS.API_PROVIDER, config.apiProvider);
            localStorage.setItem(LS_KEYS.OPENROUTER_API_KEY, config.openrouterApiKey);
            localStorage.setItem(LS_KEYS.GOOGLE_API_KEY, config.googleApiKey);
            localStorage.setItem(LS_KEYS.SELECTED_MODEL, config.selectedModel); 
            localStorage.setItem(LS_KEYS.EDUCATION_LEVEL, config.educationLevel);
            localStorage.setItem(LS_KEYS.NUM_QUESTIONS, config.numQuestions);
            localStorage.setItem(LS_KEYS.LAST_SELECTED_OR_MODEL, config.lastSelectedOpenRouterModel);
            localStorage.setItem(LS_KEYS.LAST_SELECTED_GOOGLE_MODEL, config.lastSelectedGoogleModel);
            localStorage.setItem(LS_KEYS.EXAM_NUM_DEV, config.examNumDevelopment);
            localStorage.setItem(LS_KEYS.EXAM_NUM_TEST, config.examNumTest);
            localStorage.setItem(LS_KEYS.EXAM_NUM_FILL, config.examNumFill);
            localStorage.setItem(LS_KEYS.EXAM_NUM_MULTI, config.examNumMultiTest);
            
            showToast('Configuraci√≥n guardada correctamente.', 'success');
        }

        async function testApiKey(provider) {
            let apiKey;
            let testFunction;
            let providerName;

            if (provider === 'openrouter') {
                apiKey = document.getElementById('openrouterApiKey').value.trim();
                providerName = "OpenRouter";
                if (!apiKey) {
                    showToast(`Introduce la API Key de ${providerName} para probarla.`, 'info');
                    return;
                }
                testFunction = async () => {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    if (!response.ok) {
                         const errorData = await response.json().catch(() => null);
                         throw new Error(`Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                    }
                    return response.json();
                };
            } else if (provider === 'google') {
                apiKey = document.getElementById('googleApiKey').value.trim();
                providerName = "Google Gemini";
                 if (!apiKey) {
                    showToast(`Introduce la API Key de ${providerName} para probarla.`, 'info');
                    return;
                }
                testFunction = async () => fetchGoogleModelsFromApiViaRest(apiKey); // Re-use model loading logic
            } else {
                showToast('Proveedor de API desconocido para prueba.', 'error');
                return;
            }

            showToast(`Probando API Key de ${providerName}...`, 'info');
            try {
                const data = await testFunction();
                if (provider === 'openrouter' && data.data && data.data.length > 0) {
                    showToast(`API Key de ${providerName} v√°lida. ${data.data.length} modelos encontrados.`, 'success');
                } else if (provider === 'google' && data && data.length > 0) {
                     showToast(`API Key de ${providerName} v√°lida. ${data.length} modelos compatibles encontrados.`, 'success');
                } else {
                    showToast(`API Key de ${providerName} parece v√°lida, pero no se encontraron modelos (o no compatibles).`, 'warning');
                }
                // Optionally auto-save and reload models
                if (provider === 'openrouter') config.openrouterApiKey = apiKey;
                else config.googleApiKey = apiKey;
                saveConfig(); // Save the tested key
                loadModels(false); // Reload models silently
            } catch (error) {
                showToast(`Error con la API Key de ${providerName}: ${error.message}`, 'error');
            }
        }

        // --- Model Loading ---
        async function loadModels(showAlerts = true) { 
            const select = document.getElementById('modelSelect');
            select.innerHTML = '<option value="">Cargando modelos...</option>';
            config.selectedModel = ''; // Clear current selection before loading new ones

            if (config.apiProvider === 'openrouter') {
                await loadOpenRouterModels(showAlerts);
            } else { 
                await loadGoogleModelsFromApi(showAlerts);
            }
            // After loading, try to set the select value to the (potentially new) config.selectedModel
            if (config.selectedModel && Array.from(select.options).some(opt => opt.value === config.selectedModel)) {
                select.value = config.selectedModel;
            } else if (select.options.length > 1 && select.options[1] && select.options[1].value) { // Select first available model if previous one is gone
                select.value = select.options[1].value;
                config.selectedModel = select.value;
            } else { // No models loaded
                config.selectedModel = '';
            }
        }
        
        async function loadOpenRouterModels(showAlerts = true) {
            const apiKey = config.openrouterApiKey;
            const select = document.getElementById('modelSelect');

            if (!apiKey) {
                if (showAlerts) showToast('Introduce tu API Key de OpenRouter para cargar sus modelos.', 'error');
                select.innerHTML = '<option value="">API Key de OpenRouter requerida</option>';
                return;
            }
            
            try {
                const response = await fetch('https://openrouter.ai/api/v1/models', {
                    headers: { 'Authorization': `Bearer ${apiKey}` }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    throw new Error(`Error ${response.status}: ${errorData?.error?.message || response.statusText}`);
                }

                const data = await response.json();
                availableModelsOpenRouter = data.data;

                const freeModels = availableModelsOpenRouter.filter(model => {
                    const price = parseFloat(model.pricing?.prompt || '1');
                    return price === 0 || model.id.includes(':free');
                });

                freeModels.sort((a, b) => getModelIntelligenceIndex(a.id, modelIntelligenceOrderOpenRouter) - getModelIntelligenceIndex(b.id, modelIntelligenceOrderOpenRouter));
                
                select.innerHTML = '<option value="">Selecciona un modelo de OpenRouter</option>';
                if (freeModels.length === 0) {
                     if (showAlerts) showToast('No se encontraron modelos gratuitos de OpenRouter. Mostrando todos.', 'info');
                     // Fallback to all models if no free ones
                     const allModelsSorted = [...availableModelsOpenRouter].sort((a, b) => getModelIntelligenceIndex(a.id, modelIntelligenceOrderOpenRouter) - getModelIntelligenceIndex(b.id, modelIntelligenceOrderOpenRouter));
                     allModelsSorted.forEach(model => addModelOption(select, model.id, `${model.name || model.id} (${formatContextLength(model.context_length)})`));
                } else {
                    freeModels.forEach(model => addModelOption(select, model.id, `${model.name || model.id} (${formatContextLength(model.context_length)})`));
                }
                
                // Attempt to re-select previous or first model
                const modelToSelect = config.lastSelectedOpenRouterModel || (select.options.length > 1 ? select.options[1].value : '');
                if (modelToSelect && Array.from(select.options).some(opt => opt.value === modelToSelect)) {
                    select.value = modelToSelect;
                } else if (select.options.length > 1 && select.options[1].value) {
                     select.value = select.options[1].value; // Default to first available
                }
                config.selectedModel = select.value; // Update global config

                if (showAlerts && select.options.length > 1) showToast(`${select.options.length -1} modelos de OpenRouter cargados.`, 'success');
                else if (showAlerts && select.options.length <= 1) showToast('No se encontraron modelos de OpenRouter.', 'info');

            } catch (error) {
                console.error('Error cargando modelos de OpenRouter:', error);
                select.innerHTML = `<option value="">Error al cargar OpenRouter</option><option value="deepseek/deepseek-r1-0528:free">DeepSeek R1 (Fallback)</option>`;
                if(select.options.length > 1 && select.options[1]) select.value = select.options[1].value;
                config.selectedModel = select.value;
                if (showAlerts) showToast(`Error modelos OpenRouter: ${error.message}. Usando fallback.`, 'error');
            }
        }

        async function loadGoogleModelsFromApi(showAlerts = true) {
            const select = document.getElementById('modelSelect');
            if (!config.googleApiKey) {
                if (showAlerts) showToast('Introduce tu API Key de Google para listar modelos Gemini.', 'error');
                select.innerHTML = '<option value="">API Key de Google requerida</option>';
                return;
            }

            try {
                availableGoogleModels = await fetchGoogleModelsFromApiViaRest(config.googleApiKey);
                
                select.innerHTML = '<option value="">Selecciona un modelo de Google Gemini</option>';
                if (availableGoogleModels.length === 0) {
                     if (showAlerts) showToast('No se encontraron modelos de Google compatibles mediante la API o tu API Key no tiene acceso.', 'info');
                     select.innerHTML = '<option value="">No hay modelos Gemini disponibles</option>';
                     config.selectedModel = '';
                     return;
                }

                availableGoogleModels.forEach(model => addModelOption(select, model.id, `${model.name} (${model.id.split('/')[1]})`));

                                // ‚Ä¶ dentro de loadGoogleModelsFromApi, justo despu√©s de a√±adir las <option> al select ‚Ä¶
                
                // ‚Üì Reemplaza esta l√≠nea:
                // const modelToSelect = config.lastSelectedGoogleModel || (availableGoogleModels.length > 0 ? availableGoogleModels[0].id : '');
                
                // ‚Üë Por este bloque:
                let modelToSelect = config.lastSelectedGoogleModel || '';
                if (!modelToSelect) {
                    // Buscamos primero modelos "flash"
                    const flashModels = availableGoogleModels.filter(m => m.id.includes('flash'));
                    if (flashModels.length > 0) {
                        // Ordenamos por versi√≥n (gemini-X.Y) descendente
                        flashModels.sort((a, b) => {
                            const va = parseFloat((a.id.match(/gemini-(\d+\.\d+)/) || [])[1] || 0);
                            const vb = parseFloat((b.id.match(/gemini-(\d+\.\d+)/) || [])[1] || 0);
                            return vb - va;
                        });
                        modelToSelect = flashModels[0].id;
                    } else {
                        // Si no hay flash, usamos el primero
                        modelToSelect = availableGoogleModels[0]?.id || '';
                    }
                }
                select.value = modelToSelect;
                config.selectedModel = modelToSelect;
                
                
                if (showAlerts) showToast(`${availableGoogleModels.length} modelos de Google Gemini cargados desde la API.`, 'success');

            } catch (error) {
                console.error('Error cargando modelos de Google desde API REST:', error);
                select.innerHTML = `<option value="">Error al cargar Google</option>`;
                const fallbackGoogleModels = [ 
                    { id: "models/gemini-1.5-flash-latest", name: "Gemini 1.5 Flash (Fallback)" },
                    { id: "models/gemini-pro", name: "Gemini Pro (Fallback)" }
                ];
                fallbackGoogleModels.forEach(model => addModelOption(select, model.id, model.name));
                if(select.options.length > 1 && select.options[1]) select.value = select.options[1].value;
                config.selectedModel = select.value;
                if (showAlerts) showToast(`Error modelos Google: ${error.message}. Usando fallback.`, 'error');
            }
        }

        function addModelOption(selectElement, value, text) {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = text;
            selectElement.appendChild(option);
        }

        // --- File Handling ---
        function handleFileSelection() {
            const files = Array.from(document.getElementById('fileInput').files);
            selectedFiles = files.filter(file => file.name.endsWith('.md'));

            if (selectedFiles.length === 0) {
                showToast('No se encontraron archivos .md v√°lidos.', 'error'); return;
            }
            existingQuestions = [];
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('questionsContainer').classList.add('hidden');
            document.getElementById('examConfigSection').classList.add('hidden'); 
            document.getElementById('clearFileBtn').classList.add('hidden');
            displayFilesList();
        }

        function displayFilesList() {
            const container = document.getElementById('filesList');
            const generationButtonsDiv = document.getElementById('generationButtons'); 
            const clearFileButton = document.getElementById('clearFileBtn');
            container.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `<span>üìÑ ${file.name}</span><span>${formatFileSize(file.size)}</span>`;
                item.onclick = () => selectFile(index);
                container.appendChild(item);
            });
            container.classList.remove('hidden');
            generationButtonsDiv.classList.add('hidden'); 
            clearFileButton.classList.remove('hidden'); // Show clear button when files are listed
        }

        function selectFile(index) {
            selectedFileIndex = index;
            document.querySelectorAll('.file-item').forEach((item, i) => item.classList.toggle('selected', i === index));
            document.getElementById('generationButtons').classList.remove('hidden'); 
            document.getElementById('examConfigSection').classList.add('hidden'); 
            document.getElementById('clearFileBtn').classList.remove('hidden');
            existingQuestions = [];
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('questionsContainer').classList.add('hidden');
        }

        function clearSelectedFile() {
            selectedFileIndex = -1;
            currentContent = '';
            selectedFiles = []; // Clear the array of files
            document.getElementById('fileInput').value = ''; // Reset file input
            document.getElementById('filesList').innerHTML = '';
            document.getElementById('filesList').classList.add('hidden');
            document.getElementById('generationButtons').classList.add('hidden');
            document.getElementById('examConfigSection').classList.add('hidden');
            document.getElementById('questionsContainer').classList.add('hidden');
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('clearFileBtn').classList.add('hidden');
            showToast('Selecci√≥n de archivo limpiada.', 'info');
        }
        
        // --- Core Generation Logic ---
        function validateApiConfig() {
            if (config.apiProvider === 'openrouter') {
                if (!config.openrouterApiKey) { showToast('Configura tu API Key de OpenRouter.', 'error'); return false; }
            } else { 
                if (!config.googleApiKey) { showToast('Configura tu API Key de Google.', 'error'); return false; }
            }
            if (!config.selectedModel) { showToast('Selecciona un modelo de IA en la configuraci√≥n.', 'error'); return false; }
            return true;
        }
        
        function getNumQuestionsToGenerate() {
            const num = parseInt(document.getElementById('numQuestions').value);
            if (isNaN(num) || num < 1 || num > 10) {
                showToast(`N√∫mero de preguntas inv√°lido (${num}). Usando ${DEFAULT_NUM_QUESTIONS} por defecto.`, 'info');
                return DEFAULT_NUM_QUESTIONS;
            }
            return num;
        }

        async function generateItems(type) { 
            if (!validateApiConfig()) return;
            if (selectedFileIndex === -1) { showToast('Por favor, selecciona un archivo.', 'error'); return; }

            currentQuestionType = type; 
            const file = selectedFiles[selectedFileIndex];
            currentContent = await readFileContent(file);
            existingQuestions = []; 

            const numItemsToGenerate = getNumQuestionsToGenerate();
            const typeLabels = {
                development: 'preguntas de desarrollo',
                test: 'tests (Opci√≥n √önica)',
                fill_in_the_blanks: 'ejercicios de completar texto',
                multi_choice_test: 'tests de opci√≥n m√∫ltiple'
            };
            let loadingMsg = `Generando ${numItemsToGenerate} ${typeLabels[type] || type}... (puede tardar)`;


            let questionsTitleText = "Preguntas Generadas";

            if (type === 'development') questionsTitleText = `üß† ${numItemsToGenerate} Preguntas de Desarrollo`;
            else if (type === 'test') questionsTitleText = `üìù ${numItemsToGenerate} Tests (Opci√≥n √önica)`;
            else if (type === 'fill_in_the_blanks') questionsTitleText = `üß© ${numItemsToGenerate} Ejercicios de Completar`;
            else if (type === 'multi_choice_test') questionsTitleText = `‚òëÔ∏è ${numItemsToGenerate} Tests (Opci√≥n M√∫ltiple)`;
            
            showLoading(true, loadingMsg);
            document.getElementById('questionsContainer').classList.add('hidden');
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('questionsTitle').textContent = questionsTitleText;

            try {
                // Construct prompt (same as before, simplified for brevity in this thought block)
                const prompt = buildGenerationPrompt(type, currentContent, numItemsToGenerate, []);
                
                const items = await callLLMApi(prompt, "questions_array");
                if (items && items.length > 0) {
                    displayItems(items);
                    existingQuestions = [...items]; 
                    document.getElementById('generateMoreBtn').classList.remove('hidden');
                    document.getElementById('generateMoreBtn').onclick = () => generateMoreItems(currentQuestionType); 
                } else {
                    showToast('La IA no devolvi√≥ preguntas v√°lidas. Intenta de nuevo o con otro modelo.', 'error');
                }
            } catch (error) {
                showToast(`Error al generar ${type.replace('_', ' ')}: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function generateMoreItems(typeOverride = null) {
            if (!validateApiConfig() || !currentContent) {
                showToast('Primero genera contenido para un archivo.', 'error'); return;
            }
            const typeToGenerate = typeOverride || currentQuestionType; 
            const numItemsToGenerate = getNumQuestionsToGenerate();


            const typeLabels = {
                development: 'preguntas de desarrollo',
                test: 'tests (Opci√≥n √önica)',
                fill_in_the_blanks: 'ejercicios de completar texto',
                multi_choice_test: 'tests de opci√≥n m√∫ltiple'
            };
            let loadingMsg = `Generando ${numItemsToGenerate} m√°s de ${typeLabels[typeToGenerate] || typeToGenerate}...`;
            showLoading(true, loadingMsg);

            try {
                const prompt = buildGenerationPrompt(typeToGenerate, currentContent, numItemsToGenerate, existingQuestions);
                const newItems = await callLLMApi(prompt, "questions_array");
                if (newItems && newItems.length > 0) {
                    appendItems(newItems);
                    existingQuestions = [...existingQuestions, ...newItems];
                } else {
                     showToast('La IA no devolvi√≥ m√°s preguntas v√°lidas.', 'info');
                }
            } catch (error) {
                showToast(`Error al generar m√°s: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function buildGenerationPrompt(type, content, numItems, existingItemsToAvoid) {
            let prompt = `Eres un asistente experto en crear material de estudio.
Temario base:
---
${content}
---
Por favor, genera ${numItems} preguntas basadas EXCLUSIVAMENTE en el temario proporcionado.
Lim√≠tate al formato JSON indicado. No incluyas explicaciones, contexto adicional o palabras fuera del formato JSON.
La respuesta debe ser √∫nicamente un array JSON.`;

            if (existingItemsToAvoid && existingItemsToAvoid.length > 0) {
                 prompt += `\nPreguntas ya creadas (evita repetirlas o hacerlas muy similares):\n${existingItemsToAvoid.map(q => `- ${q.question}`).join('\n')}`;
            }

            if (type === 'development') {
                prompt += `
Tipo de pregunta: Desarrollo corto.
**Formato Obligatorio para cada pregunta (JSON Array):**
[ {"question_type": "development", "question": "Pregunta de desarrollo 1"}, ... ]`;
            } else if (type === 'test') {
                prompt += `
Tipo de pregunta: Test de opci√≥n m√∫ltiple (una sola respuesta correcta). 4 opciones (A, B, C, D).
**Formato Obligatorio para cada pregunta (JSON Array):**
[ { "question_type": "test", "question": "...", "options": { "A": "...", "B": "...", "C": "...", "D": "..." }, "correct_option": "C", "justification": "..." }, ... ]`;
            } else if (type === 'fill_in_the_blanks') {
                 prompt += `
Tipo de pregunta: Completar texto (rellenar huecos). 1-3 huecos.
**Formato Obligatorio para cada pregunta (JSON Array):**
[ { "question_type": "fill_in_the_blanks", "question": "Completa:", "text_parts": ["El sol ", " por el este."], "solutions": ["sale"] }, ... ]`;
            } else if (type === 'multi_choice_test') {
                prompt += `
Tipo de pregunta: Test de opci√≥n m√∫ltiple (UNA O M√ÅS respuestas pueden ser correctas). 4-5 opciones.
**Formato Obligatorio para cada pregunta (JSON Array):**
[ { "question_type": "multi_choice_test", "question": "...", "options": { "A": "...", "B": "...", "C": "...", "D": "..." }, "correct_options": ["A", "C"], "justification": "..." }, ... ]`;
            }
            return prompt;
        }


        function toggleExamConfig() {
            const examConfigSection = document.getElementById('examConfigSection');
            examConfigSection.classList.toggle('hidden');
        }

        async function generateExam() {
            if (!validateApiConfig()) return;
            if (selectedFileIndex === -1) { showToast('Por favor, selecciona un archivo.', 'error'); return; }

            const numDev = parseInt(document.getElementById('examNumDevelopment').value) || 0;
            const numTest = parseInt(document.getElementById('examNumTest').value) || 0;
            const numFill = parseInt(document.getElementById('examNumFill').value) || 0;
            const numMultiTest = parseInt(document.getElementById('examNumMultiTest').value) || 0;

            const totalExamQuestions = numDev + numTest + numFill + numMultiTest;

            if (totalExamQuestions === 0) {
                showToast('Especifica al menos una pregunta para el examen.', 'error');
                return;
            }
            if (totalExamQuestions > 20) { 
                showToast('El n√∫mero total de preguntas para el examen no debe exceder 20.', 'error');
                return;
            }

            currentContent = await readFileContent(selectedFiles[selectedFileIndex]);
            existingQuestions = []; 
            currentQuestionType = 'exam'; 

            showLoading(true, `Generando examen con ${totalExamQuestions} preguntas variadas...`);
            document.getElementById('questionsContainer').classList.add('hidden');
            document.getElementById('questionsList').innerHTML = '';
            document.getElementById('questionsTitle').textContent = `üéì Examen Mixto Generado (${totalExamQuestions} preguntas)`;
            document.getElementById('examConfigSection').classList.add('hidden'); 

            try {
                let prompt = `Eres un asistente experto en crear ex√°menes diversificados.
Temario base:
---
${currentContent}
---
Por favor, genera un examen mixto basado EXCLUSIVAMENTE en el temario proporcionado.
El examen debe contener EXACTAMENTE la siguiente distribuci√≥n de preguntas, PERO MEZCLADAS EN ORDEN ALEATORIO Y NATURAL, no agrupadas por tipo:
- ${numDev} preguntas de tipo "development".
- ${numTest} preguntas de tipo "test" (opci√≥n √∫nica, 4 opciones A,B,C,D).
- ${numFill} preguntas de tipo "fill_in_the_blanks" (completar texto, 1-3 huecos).
- ${numMultiTest} preguntas de tipo "multi_choice_test" (opci√≥n m√∫ltiple, UNA O M√ÅS correctas, 4-5 opciones).

Aseg√∫rate de que el contenido de cada pregunta sea el m√°s adecuado para su tipo.
La respuesta debe ser un √öNICO array JSON que contenga TODAS las ${totalExamQuestions} preguntas.
Cada objeto de pregunta DEBE incluir "question_type" con: "development", "test", "fill_in_the_blanks", o "multi_choice_test".
Sigue estrictamente los formatos JSON para cada tipo. No incluyas texto fuera del JSON.

Formatos JSON (ejemplos):
1. Development: {"question_type": "development", "question": "..."}
2. Test: {"question_type": "test", "question": "?", "options": {"A":"OpA", ...}, "correct_option": "C", "justification": "..."}
3. Fill Blanks: {"question_type": "fill_in_the_blanks", "question": "Completa:", "text_parts": ["Parte 1 ", " parte 2."], "solutions": ["sol1"]}
4. Multi-Choice Test: {"question_type": "multi_choice_test", "question": "?", "options": {"A":"OpA", ...}, "correct_options": ["A", "C"], "justification": "..."}

Genera el array JSON y nada m√°s.`;

                const items = await callLLMApi(prompt, "questions_array");

                if (items && items.length > 0) {
                    if (items.length !== totalExamQuestions) {
                        showToast(`IA gener√≥ ${items.length} en lugar de ${totalExamQuestions} preguntas. Mostrando las generadas.`, 'info');
                    }
                    displayItems(items);
                    existingQuestions = [...items];
                    document.getElementById('generateMoreBtn').classList.add('hidden'); 
                } else {
                    showToast('La IA no devolvi√≥ preguntas v√°lidas para el examen. Intenta de nuevo.', 'error');
                }
            } catch (error) {
                showToast(`Error al generar examen: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // --- API Call & Parsing ---
        async function callLLMApi(prompt, expectedJsonType = "questions_array") {
            const modelId = config.selectedModel;
            let responseText;

            if (config.apiProvider === 'openrouter') {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.openrouterApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ model: modelId, messages: [{ role: 'user', content: prompt }] })
                });
                if (!response.ok) { 
                    const errorText = await response.text();
                    throw new Error(`OpenRouter Error ${response.status}: ${errorText.substring(0, 200)}`); 
                }
                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
                     throw new Error('Respuesta inesperada de OpenRouter. No se encontr√≥ contenido.');
                }
                responseText = data.choices[0].message.content;

            } else { // google (REST API)
                const GOOGLE_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/${modelId}:generateContent?key=${config.googleApiKey}`;
                const requestBody = {
                    contents: [{ parts: [{ text: prompt }] }],
                     generationConfig: { responseMimeType: "application/json" } 
                };

                const response = await fetch(GOOGLE_API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    console.error("Google API Error Response:", errorData);
                    throw new Error(`Google API Error ${response.status}: ${errorData.error?.message || errorData.message}`);
                }
                const data = await response.json();
                
                if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                    responseText = data.candidates[0].content.parts[0].text;
                } else {
                    console.error("Respuesta inesperada de Google API:", data);
                    if (data.promptFeedback && data.promptFeedback.blockReason) {
                         throw new Error(`Prompt bloqueado por Google API: ${data.promptFeedback.blockReason}. ${data.promptFeedback.blockReasonMessage || ''}`);
                    }
                    throw new Error("Formato de respuesta de Google API inesperado.");
                }
            }
            
            const jsonWrapperMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
            responseText = jsonWrapperMatch && jsonWrapperMatch[1] ? jsonWrapperMatch[1] : responseText;
            
            try {
                const parsedJson = JSON.parse(responseText);
                if (expectedJsonType === "questions_array" && !Array.isArray(parsedJson)) {
                    if (typeof parsedJson === 'object' && parsedJson !== null && (Array.isArray(parsedJson.questions) || Array.isArray(parsedJson.exam))) {
                        return parsedJson.questions || parsedJson.exam;
                    }
                    console.warn("Respuesta no fue un array JSON. Intentando como objeto con clave 'questions' o 'exam'. Contenido:", responseText.substring(0, 500));
                    throw new Error("Respuesta de IA no fue un array JSON como se esperaba.");
                }
                if (expectedJsonType === "evaluation_object" && (Array.isArray(parsedJson) || typeof parsedJson !== 'object')) {
                     console.warn("Respuesta no fue un objeto JSON para evaluaci√≥n. Contenido:", responseText.substring(0, 500));
                     throw new Error("Respuesta de IA no fue un objeto JSON para evaluaci√≥n.");
                }
                return parsedJson;
            } catch (e) {
                console.error("Error al parsear JSON:", e, "Respuesta original:", responseText);
                throw new Error(`Formato de IA inv√°lido: ${e.message}. Ver consola para detalles. Contenido inicial: ${responseText.substring(0,150)}...`);
            }
        }

        // --- Display & Interaction with Questions (largely unchanged, check specific functions for minor tweaks) ---
        function displayItems(items) {
            const container = document.getElementById('questionsContainer');
            const list = document.getElementById('questionsList');
            list.innerHTML = ''; 
            items.forEach((item, index) => {
                if (!item || !item.question_type || (item.question_type !== 'fill_in_the_blanks' && !item.question) ) { // fill_in_the_blanks might not have a global "question"
                    console.warn("Saltando √≠tem inv√°lido:", item);
                    const errorItemEl = document.createElement('div');
                    errorItemEl.className = 'question-item';
                    errorItemEl.innerHTML = `<p class="alert alert-error">Error: Pregunta mal formada recibida de la API. Ver consola.</p>`;
                    list.appendChild(errorItemEl);
                    return; 
                }
                const itemEl = createItemElement(item, index);
                list.appendChild(itemEl);
            });
            container.classList.remove('hidden');
        }

        function appendItems(items) {
            const list = document.getElementById('questionsList');
            const currentItemCount = list.children.length;
            items.forEach((item, index) => {
                 if (!item || !item.question_type || (item.question_type !== 'fill_in_the_blanks' && !item.question)) {
                    console.warn("Saltando √≠tem inv√°lido para append:", item);
                    return; 
                }
                const itemEl = createItemElement(item, currentItemCount + index);
                list.appendChild(itemEl);
            });
        }
        
        function createItemElement(itemData, index) {
            const div = document.createElement('div');
            div.className = 'question-item';
            div.setAttribute('data-id', index); 
            
            let questionText = itemData.question || `Pregunta ${index + 1} (${itemData.question_type.replace('_', ' ')})`;
            if (itemData.question_type === 'fill_in_the_blanks' && itemData.question) { // Use specific instruction if available
                questionText = itemData.question;
            } else if (itemData.question_type === 'fill_in_the_blanks' && !itemData.question) {
                questionText = "üß© Completa los huecos:";
            }


            let itemHTML = `<div class="question-text">`;
            if (itemData.question_type === 'development') itemHTML += 'üß† ';
            else if (itemData.question_type === 'test') itemHTML += 'üìù ';
            else if (itemData.question_type === 'fill_in_the_blanks') itemHTML += 'üß© ';
            else if (itemData.question_type === 'multi_choice_test') itemHTML += '‚òëÔ∏è ';
            itemHTML += `${questionText}</div>`;


            if (itemData.question_type === 'development') {
                itemHTML += `
                    <textarea class="answer-input" id="answer-${index}" placeholder="Escribe tu respuesta aqu√≠..."></textarea>
                    <button class="btn btn-primary" onclick="checkDevelopmentAnswer(${index})">
                        ‚úîÔ∏è Comprobar Desarrollo
                    </button>
                `;
            } else if (itemData.question_type === 'test') { 
                itemHTML += '<div class="test-options">';
                if (itemData.options && typeof itemData.options === 'object') {
                    for (const key in itemData.options) {
                        itemHTML += `
                            <label class="test-option" for="option-${index}-${key}">
                                <input type="radio" name="options-${index}" id="option-${index}-${key}" value="${key}">
                                ${key}) ${itemData.options[key]}
                            </label>
                        `;
                    }
                } else { itemHTML += `<p class="alert alert-error">Error: Opciones no encontradas.</p>`;}
                itemHTML += '</div>';
                itemHTML += `
                    <button class="btn btn-primary" onclick="checkTestAnswer(${index})">
                        ‚úîÔ∏è Comprobar Test (Op. √önica)
                    </button>
                `;
                        // ‚Ä¶ dentro de createItemElement(itemData, index) reemplaza el bloque de fill_in_the_blanks por:
            } else if (itemData.question_type === 'fill_in_the_blanks') {
                // Siempre mostramos un encabezado gen√©rico
                itemHTML = `<div class="question-text">üß© Completa los huecos:</div>`;
                if (itemData.text_parts && Array.isArray(itemData.text_parts) && itemData.solutions && Array.isArray(itemData.solutions)) {
                    itemHTML += '<div class="text-part-fill">';
                    itemData.text_parts.forEach((part, i) => {
                        itemHTML += `<span>${marked.parseInline(part || "")}</span>`;
                        if (i < itemData.solutions.length) {
                            itemHTML += `<input type="text" class="fill-blank-input" id="fill-${index}-${i}" placeholder="Hueco ${i+1}">`;
                        }
                    });
                    itemHTML += '</div>';
                    itemHTML += `
                        <button class="btn btn-primary" onclick="checkFillInTheBlanksAnswer(${index})">
                            ‚úîÔ∏è Comprobar Completar
                        </button>
                    `;
                } else {
                    itemHTML += `<p class="alert alert-error">Error: Formato de completar texto inv√°lido.</p>`;
                } 
            }else if (itemData.question_type === 'multi_choice_test') { 
                itemHTML += '<div class="test-options">';
                if (itemData.options && typeof itemData.options === 'object') {
                    for (const key in itemData.options) {
                        itemHTML += `
                            <label class="test-option" for="option-${index}-${key}">
                                <input type="checkbox" name="options-${index}-${key}" id="option-${index}-${key}" value="${key}">
                                ${key}) ${itemData.options[key]}
                            </label>
                        `;
                    }
                } else { itemHTML += `<p class="alert alert-error">Error: Opciones no encontradas.</p>`;}
                itemHTML += '</div>';
                itemHTML += `
                    <button class="btn btn-primary" onclick="checkMultiTestAnswer(${index})">
                        ‚úîÔ∏è Comprobar Test (Op. M√∫ltiple)
                    </button>
                `;
            }

            itemHTML += `<div class="result-container" id="result-${index}"></div>`;
            div.innerHTML = itemHTML;
            return div;
        }
        
        async function checkDevelopmentAnswer(index) {
            if (!validateApiConfig()) return;
            const itemData = existingQuestions[index];
            if (!itemData) { showToast('Error: Datos de pregunta no encontrados.', 'error'); return; }
            const answer = document.getElementById(`answer-${index}`).value.trim();
            if (!answer) { showToast('Por favor, escribe una respuesta', 'info'); return; }

            const resultContainer = document.getElementById(`result-${index}`);
            resultContainer.innerHTML = '<div class="spinner"></div><p>Evaluando respuesta...</p>';
            resultContainer.style.display = 'block';
            resultContainer.className = 'result-container'; 

            try {
                const prompt = `Eval√∫a la siguiente respuesta a la pregunta de desarrollo. S√© estricto pero justo.
Adapta la explicaci√≥n al nivel de educaci√≥n: ${config.educationLevel}. La explicaci√≥n debe estar en formato Markdown.
Pregunta:
${itemData.question}
Respuesta del usuario:
${answer}
**Formato Obligatorio (solo el JSON object):**
{
    "score": <un n√∫mero entero del 0 al 100 que representa la calidad de la respuesta>,
    "explanation": "Explicaci√≥n en Markdown de por qu√© se ha asignado esa puntuaci√≥n (lenguaje apropiado para ${config.educationLevel})."
}
Aseg√∫rate de que la respuesta contenga √∫nicamente el objeto JSON y nada m√°s.

Temario relevante para la evaluaci√≥n:
${currentContent} 
`;

                const result = await callLLMApi(prompt, "evaluation_object");

                // Validate the new format
                if (typeof result.score !== 'number' || result.score < 0 || result.score > 100) {
                    console.error("La IA no devolvi√≥ un 'score' v√°lido.", result);
                    const explanation = result.explanation || "No se recibi√≥ explicaci√≥n.";
                    const fallbackResult = { 
                        status: 'incorrecto', 
                        explanation: `**Error de formato de la IA:** No se pudo obtener una puntuaci√≥n v√°lida.\n\n**Respuesta original de la IA:**\n${explanation}`
                    };
                    displayEvaluationResult(index, fallbackResult, itemData.question, answer, itemData.question_type);
                    return; // Exit after displaying the formatted error
                }

                displayEvaluationResult(index, result, itemData.question, answer, itemData.question_type);
            } catch (error) {
                resultContainer.innerHTML = `<p>‚ùå Error al evaluar: ${error.message}</p>`;
                resultContainer.className = 'result-container result-incorrect';
                showToast(`Error al evaluar: ${error.message}`, 'error');
            }
        }

        function checkTestAnswer(index) { 
            const itemData = existingQuestions[index];
            if (!itemData || !itemData.options) { showToast('Error: Datos de test no encontrados.', 'error'); return; }
            const selectedOptionInput = document.querySelector(`input[name="options-${index}"]:checked`);
            
            if (!selectedOptionInput) { showToast('Selecciona una opci√≥n.', 'info'); return; }
            const userAnswer = selectedOptionInput.value; 
            const isCorrect = userAnswer === itemData.correct_option;
            
            document.querySelectorAll(`#questionsList .question-item[data-id="${index}"] .test-option`).forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                label.classList.remove('selected-option', 'correct-option', 'incorrect-option');
                if (input.value === itemData.correct_option) label.classList.add('correct-option');
                if (input.checked) {
                    label.classList.add('selected-option');
                    if (!isCorrect && input.value !== itemData.correct_option) label.classList.add('incorrect-option');
                }
            });

            displayEvaluationResult(index, 
                { status: isCorrect ? 'correcto' : 'incorrecto', explanation: itemData.justification || (isCorrect ? "Respuesta correcta." : "Respuesta incorrecta.") }, 
                itemData.question, `Opci√≥n ${userAnswer}: ${itemData.options[userAnswer]}`, itemData.question_type);
        }

        function checkFillInTheBlanksAnswer(index) {
            const itemData = existingQuestions[index];
            if (!itemData || !itemData.text_parts || !itemData.solutions) { showToast('Error: Datos para completar no encontrados.', 'error'); return; }

            const userAnswers = [];
            let allFilled = true;
            for (let i = 0; i < itemData.solutions.length; i++) {
                const inputElement = document.getElementById(`fill-${index}-${i}`);
                const val = inputElement ? inputElement.value.trim() : "";
                if (!val) allFilled = false;
                userAnswers.push(val);
            }

            if (!allFilled) { showToast('Rellena todos los huecos.', 'info'); return; }

            let correctCount = 0;
            let explanation = "Resultado:\n";
            itemData.solutions.forEach((solution, i) => {
                const userAnswerNormalized = userAnswers[i].toLowerCase();
                const solutionNormalized = solution.toLowerCase();
                const inputElement = document.getElementById(`fill-${index}-${i}`);
                if (userAnswerNormalized === solutionNormalized) {
                    correctCount++;
                    explanation += `- Hueco ${i+1}: "${userAnswers[i]}" (Correcto).\n`;
                    if(inputElement) inputElement.style.borderColor = 'green';
                } else {
                    explanation += `- Hueco ${i+1}: "${userAnswers[i]}" (Incorrecto, era "${solution}").\n`;
                    if(inputElement) inputElement.style.borderColor = 'red';
                }
            });

            let status = correctCount === itemData.solutions.length ? 'correcto' : (correctCount > 0 ? 'parcialmente_correcto' : 'incorrecto');
            explanation = (status === 'correcto' ? "¬°Todos los huecos son correctos!\n" : (status === 'parcialmente_correcto' ? "Algunos huecos son correctos.\n" : "Ning√∫n hueco es correcto.\n")) + (itemData.justification || explanation);
            
            const fullUserAnswerText = itemData.text_parts.reduce((acc, part, i) => acc + part + (userAnswers[i] ? `**[${userAnswers[i]}]**` : '**[VAC√çO]**'), "");
            displayEvaluationResult(index, { status, explanation }, itemData.question || "Completar texto", `Tu respuesta: ${fullUserAnswerText}`, itemData.question_type);
        }

        function checkMultiTestAnswer(index) { 
            const itemData = existingQuestions[index];
            if (!itemData || !itemData.options || !Array.isArray(itemData.correct_options)) { showToast('Error: Datos multichoice no encontrados.', 'error'); return; }
            const selectedOptionInputs = document.querySelectorAll(`input[name^="options-${index}-"]:checked`);
            if (selectedOptionInputs.length === 0) { showToast('Selecciona al menos una opci√≥n.', 'info'); return; }

            const userAnswers = Array.from(selectedOptionInputs).map(input => input.value);
            const correctOptions = itemData.correct_options;
            let isFullyCorrect = userAnswers.length === correctOptions.length && userAnswers.every(ans => correctOptions.includes(ans));

            document.querySelectorAll(`#questionsList .question-item[data-id="${index}"] .test-option`).forEach(label => {
                const input = label.querySelector('input[type="checkbox"]');
                label.classList.remove('selected-option', 'correct-option', 'incorrect-option');
                if (correctOptions.includes(input.value)) label.classList.add('correct-option');
                if (input.checked) {
                    label.classList.add('selected-option');
                    if (!correctOptions.includes(input.value)) label.classList.add('incorrect-option');
                }
            });
            
            let status, explanationText = itemData.justification || "";
            if (isFullyCorrect) {
                status = 'correcto';
                explanationText = "¬°Todas las selecciones son correctas! " + explanationText;
            } else {
                const correctlySelected = userAnswers.filter(ans => correctOptions.includes(ans)).length;
                const incorrectlySelected = userAnswers.filter(ans => !correctOptions.includes(ans)).length;
                status = (correctlySelected > 0 && incorrectlySelected === 0 && correctlySelected < correctOptions.length) ? 'parcialmente_correcto' : 'incorrecto';
                explanationText = (status === 'parcialmente_correcto' ? "Algunas selecciones correctas, pero faltaron otras. " : "Tu selecci√≥n no es completamente correcta. ") + explanationText;
            }
            const userAnswerTextCombined = userAnswers.map(ua => `Opci√≥n ${ua}: ${itemData.options[ua]}`).join(', ');
            displayEvaluationResult(index, { status, explanation: explanationText }, itemData.question, userAnswerTextCombined, itemData.question_type);
        }
        

        function displayEvaluationResult(index, result, questionText, userAnswerText, questionType) {
            const container = document.getElementById(`result-${index}`);
            const explanationHtml = marked.parse(result.explanation || "No se proporcion√≥ explicaci√≥n.", { gfm: true, breaks: true });

            let headerHtml = '';
            let containerClass = 'result-container';
            let containerStyle = { backgroundColor: '', border: '', color: '' };

            if (typeof result.score === 'number' && questionType === 'development') {
                const score = Math.round(result.score);
                headerHtml = `<h4>üìä Puntuaci√≥n: ${score}/100</h4>`;
                const scoreColor = getScoreColor(score);
                const borderColor = score >= 90 ? '#c3e6cb' : (score >= 50 ? '#ffeeba' : '#f5c6cb');
                containerStyle = { backgroundColor: scoreColor, border: `2px solid ${borderColor}`, color: '#333' };
            } else {
                const isCorrect = result.status === 'correcto';
                const isPartial = result.status === 'parcialmente_correcto';
                const emoji = isCorrect ? '‚úÖ' : (isPartial ? 'üü†' : '‚ùå');
                headerHtml = `<h4>${emoji} Resultado: ${result.status.replace(/_/g, ' ')}</h4>`;
                containerClass = `result-container ${isCorrect ? 'result-correct' : (isPartial ? 'result-warning' : 'result-incorrect')}`;
            }

            // --- PASO 1: Generar HTML sin onclick, pero con IDs ---
            const rebuttalSectionHtml = `
                <div class="rebuttal-section hidden" id="rebuttal-${index}">
                    <label for="rebuttal-text-${index}">Tu argumento:</label>
                    <textarea id="rebuttal-text-${index}" placeholder="Explica por qu√© crees que tu respuesta es correcta o la evaluaci√≥n necesita revisi√≥n..."></textarea>
                    <button id="submit-rebuttal-btn-${index}" class="btn btn-primary btn-sm">Enviar respuesta</button>
                </div>
            `;
            
            container.innerHTML = `
                ${headerHtml}
                <div class="explanation-section">
                    <strong>üìñ Justificaci√≥n:</strong>
                    <div class="markdown-content" id="explanation-${index}">${explanationHtml}</div>
                </div>
                <button id="re-explain-btn-${index}" class="btn btn-warning btn-sm">üîÅ Explicar otra vez</button>
                ${questionType === 'development' ? `<button id="rebut-btn-${index}" class="btn btn-secondary btn-sm">üó£Ô∏è Rebatir</button>` : ''}
                ${questionType === 'development' ? rebuttalSectionHtml : ''}
            `;

            // Aplicar estilos
            container.className = containerClass;
            Object.assign(container.style, containerStyle);
            container.style.display = 'block';

            // --- PASO 2: A√±adir listeners de forma program√°tica ---
            const reExplainBtn = document.getElementById(`re-explain-btn-${index}`);
            if (reExplainBtn) {
                reExplainBtn.addEventListener('click', () => {
                    reExplainAnswer(index, questionText, userAnswerText, questionType);
                });
            }

            if (questionType === 'development') {
                const rebutBtn = document.getElementById(`rebut-btn-${index}`);
                if (rebutBtn) {
                    rebutBtn.addEventListener('click', () => {
                        // Pasamos solo el index, el resto de datos se los pasamos a la funci√≥n de env√≠o
                        showRebuttalInput(index); 
                    });
                }
                
                const submitRebuttalBtn = document.getElementById(`submit-rebuttal-btn-${index}`);
                if (submitRebuttalBtn) {
                    submitRebuttalBtn.addEventListener('click', () => {
                        // Ahora la funci√≥n de env√≠o necesita los datos
                        submitRebuttal(index, questionText, userAnswerText, result.explanation || "");
                    });
                }
            }
        }


        async function reExplainAnswer(index, question, userAnswer, questionType) {
            if (!validateApiConfig()) return;
            const explanationDiv = document.getElementById(`explanation-${index}`);
            if (!explanationDiv) return;
            
            const itemData = existingQuestions[index];
            let originalExplanation = "No hay explicaci√≥n previa."; // Default
            // Extract current explanation carefully
            const currentExplanationElement = document.getElementById(`explanation-${index}`);
            if (currentExplanationElement) originalExplanation = currentExplanationElement.innerText; // Get text content


            const prompt = `La pregunta original (${questionType}) fue: "${question}"
La respuesta del usuario fue: "${userAnswer}"
La explicaci√≥n anterior de la IA fue: "${originalExplanation}"

Por favor, proporciona una NUEVA y DIFERENTE explicaci√≥n para la respuesta del usuario a la pregunta.
Adapta la nueva explicaci√≥n al nivel de educaci√≥n: ${config.educationLevel}.
Debe estar en formato Markdown y ser lo m√°s clara y sencilla posible.
Devuelve S√ìLO la explicaci√≥n en Markdown, sin ning√∫n texto adicional o formato JSON.

El temario es:
${currentContent}
`;

            explanationDiv.innerHTML = '<span class="spinner" style="width:20px; height:20px; border-width:3px; display:inline-block; vertical-align:middle;"></span> Reformulando...';

            try {
                // Call API without expecting JSON (plain text explanation)
                let newExplanationMarkdown;
                const modelId = config.selectedModel;

                 if (config.apiProvider === 'openrouter') {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${config.openrouterApiKey}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: modelId, messages: [{ role: 'user', content: prompt }] })
                    });
                    if (!response.ok) { const err = await response.text(); throw new Error(`OpenRouter ${response.status}: ${err.substring(0,100)}`); }
                    const data = await response.json();
                    newExplanationMarkdown = data.choices[0].message.content.trim();
                } else { 
                    const GOOGLE_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/${modelId}:generateContent?key=${config.googleApiKey}`;
                    // For Google, even for plain text, we usually send it this way and get text back
                    const requestBody = { contents: [{ parts: [{ text: prompt }] }] }; 
                    
                    const response = await fetch(GOOGLE_API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: response.statusText }));
                        throw new Error(`Google API ${response.status}: ${errorData.error?.message || errorData.message}`);
                    }
                    const data = await response.json();
                    if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) {
                        newExplanationMarkdown = data.candidates[0].content.parts[0].text.trim();
                    } else { throw new Error("Respuesta de Google API inesperada al reformular."); }
                }
                explanationDiv.innerHTML = marked.parse(newExplanationMarkdown, { gfm: true, breaks: true });
            } catch (error) {
                explanationDiv.innerHTML = `‚ùå Error al reformular: ${error.message}`;
                showToast(`Error al reformular: ${error.message}`, 'error');
            }
        }
        
        function showRebuttalInput(index) {
            const rebuttalSection = document.getElementById(`rebuttal-${index}`);
            if (rebuttalSection) {
                // classList.toggle es simple y deber√≠a funcionar ahora que el listener es robusto.
                rebuttalSection.classList.toggle('hidden');
            }
        }

        async function submitRebuttal(index, question, userAnswer, currentExplanation) {
            if (!validateApiConfig()) return;
            const rebuttalSection = document.getElementById(`rebuttal-${index}`);
            const rebuttalText = document.getElementById(`rebuttal-text-${index}`).value.trim();
            if (!rebuttalText) { showToast('Escribe tu argumento para el rebate.', 'info'); return; }

            const explanationDiv = document.getElementById(`explanation-${index}`);
            explanationDiv.innerHTML = '<span class="spinner" style="width:20px; height:20px; border-width:3px; display:inline-block; vertical-align:middle;"></span> Procesando rebate...';

            const prompt = `
Pregunta original: "${question}"
Respuesta del usuario: "${userAnswer}"
Explicaci√≥n previa de la IA: "${currentExplanation}"
Argumento del usuario (rebate): "${rebuttalText}"

Re-eval√∫a la respuesta del usuario y proporciona una nueva explicaci√≥n detallada en Markdown.
Si cambias tu evaluaci√≥n (ej. de incorrecto a correcto), ind√≠calo claramente.
Adapta tu lenguaje al nivel ${config.educationLevel}. Devuelve S√ìLO la nueva explicaci√≥n en Markdown y di la nota nueva en la explicaci√≥n si te la pide.
Contexto del temario:
${currentContent}
`;

            try {
                // El resto de la l√≥gica de la API es la misma y est√° bien.
                let newExplanationMarkdown;
                const modelId = config.selectedModel;
                if (config.apiProvider === 'openrouter') {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', { method: 'POST', headers: { 'Authorization': `Bearer ${config.openrouterApiKey}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ model: modelId, messages: [{ role: 'user', content: prompt }] }) });
                    if (!response.ok) { const err = await response.text(); throw new Error(`OpenRouter Error ${response.status}: ${err.substring(0,100)}`); }
                    const data = await response.json(); newExplanationMarkdown = data.choices[0].message.content.trim();
                } else {
                    const GOOGLE_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/${modelId}:generateContent?key=${config.googleApiKey}`;
                    const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(GOOGLE_API_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
                    if (!response.ok) { const errorData = await response.json().catch(() => ({ message: response.statusText })); throw new Error(`Google API Error ${response.status}: ${errorData.error?.message || errorData.message}`);}
                    const data = await response.json(); if (data.candidates && data.candidates[0]?.content?.parts[0]?.text) { newExplanationMarkdown = data.candidates[0].content.parts[0].text.trim(); } else { throw new Error("Respuesta de Google API inesperada al procesar rebate."); }
                }
                explanationDiv.innerHTML = marked.parse(newExplanationMarkdown, { gfm: true, breaks: true });
                rebuttalSection.classList.add('hidden'); 
                document.getElementById(`rebuttal-text-${index}`).value = ''; 
            } catch (error) {
                explanationDiv.innerHTML = `‚ùå Error procesando rebate: ${error.message}`;
                showToast(`Error procesando rebate: ${error.message}`, 'error');
            }
        }


        // --- UI Utilities ---
        function showLoading(show, message = "Procesando...") {
            const loadingDiv = document.getElementById('loading');
            document.getElementById('loadingMessage').textContent = message;
            loadingDiv.style.display = show ? 'block' : 'none';
        }

        function showToast(message, type = 'info') { 
            const container = document.getElementById('notification-container');
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show')); // Ensures transition happens

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500); 
            }, 4500); 
        }

        function getScoreColor(score) {
            score = Math.max(0, Math.min(100, score)); // Clamp score

            const red = { r: 248, g: 215, b: 218 };     // #f8d7da
            const orange = { r: 255, g: 243, b: 205 }; // #fff3cd
            const green = { r: 212, g: 237, b: 218 };   // #d4edda

            let r, g, b;

            if (score <= 10) {
                return `rgb(${red.r}, ${red.g}, ${red.b})`;
            }
            if (score >= 90) {
                return `rgb(${green.r}, ${green.g}, ${green.b})`;
            }

            if (score < 50) {
                // Interpolate between red (at score 10) and orange (at score 50)
                const ratio = (score - 10) / (50 - 10);
                r = Math.round(red.r + (orange.r - red.r) * ratio);
                g = Math.round(red.g + (orange.g - red.g) * ratio);
                b = Math.round(red.b + (orange.b - red.b) * ratio);
            } else { // score is >= 50 and < 90
                // Interpolate between orange (at score 50) and green (at score 90)
                const ratio = (score - 50) / (90 - 50);
                r = Math.round(orange.r + (green.r - orange.r) * ratio);
                g = Math.round(orange.g + (green.g - orange.g) * ratio);
                b = Math.round(orange.b + (green.b - orange.b) * ratio);
            }

            return `rgb(${r}, ${g}, ${b})`;
        }

        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }
        function getModelIntelligenceIndex(modelId, orderArray) { // Helper from original
            for (let i = 0; i < orderArray.length; i++) {
                if (modelId.toLowerCase().includes(orderArray[i].toLowerCase()) ||
                    modelId.toLowerCase().startsWith(orderArray[i].toLowerCase())) {
                    return i;
                }
            }
            return orderArray.length;
        }
        function readFileContent(file) { // Helper from original
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
         async function fetchGoogleModelsFromApiViaRest(apiKey) { // Helper from original, slightly adapted
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ message: response.statusText }));
                throw new Error(`Error ${response.status} al obtener modelos de Google: ${errorData.error?.message || errorData.message}`);
            }
            const data = await response.json();
            if (!data.models) return []; // Handle case where models array might be missing
            return data.models
                .filter(model => model.supportedGenerationMethods && model.supportedGenerationMethods.includes("generateContent") &&
                                 !model.displayName?.toLowerCase().includes("embedding") &&
                                 !model.name?.toLowerCase().includes("vision") && 
                                 !model.displayName?.toLowerCase().includes("deprecated") &&
                                 (model.name?.includes("gemini") || model.name?.includes("gemma")) 
                                 )
                .map(model => ({ id: model.name, name: model.displayName }))
                .sort((a,b) => a.name.localeCompare(b.name));
        }
        function formatContextLength(length) { // Helper from original
            if (!length) return 'N/A';
            if (length >= 1000000) return `${(length / 1000000).toFixed(1)}M tokens`;
            if (length >= 1000) return `${(length / 1000).toFixed(0)}K tokens`;
            return `${length} tokens`;
        }

        // --- Event Listener ---
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
